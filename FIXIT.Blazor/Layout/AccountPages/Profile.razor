@page "/profile"
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>My Profile</PageTitle>

<div class="profile-wrapper">
    <div class="profile-card">

        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading your profile...</p>
            </div>
        }
        else
        {
            <!-- Header / Avatar Section -->
            <div class="profile-header">
                <div class="avatar-wrapper">
                    @if (!string.IsNullOrWhiteSpace(userImg))
                    {
                        <img src="@userImg" alt="Profile Picture" class="avatar-img" />
                    }
                    else
                    {
                        <div class="avatar-placeholder">
                            <span>@GetInitials()</span>
                        </div>
                    }
                    <div class="avatar-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4z"/>
                        </svg>
                    </div>
                </div>

                <h2 class="profile-name">@(string.IsNullOrWhiteSpace(fullName) ? userName : fullName)</h2>
                <p class="profile-username">@@@userName</p>

                <button class="btn-edit" @onclick="GoToEdit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                    </svg>
                    Edit Profile
                </button>
            </div>

            <!-- Info Cards -->
            <div class="info-grid">

                <div class="info-card">
                    <div class="info-icon email-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                        </svg>
                    </div>
                    <div class="info-content">
                        <span class="info-label">Email</span>
                        <span class="info-value">@(string.IsNullOrWhiteSpace(email) ? "Not provided" : email)</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-icon phone-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"/>
                        </svg>
                    </div>
                    <div class="info-content">
                        <span class="info-label">Phone</span>
                        <span class="info-value">@(string.IsNullOrWhiteSpace(phone) ? "Not provided" : phone)</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-icon user-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                        </svg>
                    </div>
                    <div class="info-content">
                        <span class="info-label">Username</span>
                        <span class="info-value">@(string.IsNullOrWhiteSpace(userName) ? "Not provided" : userName)</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-icon id-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm.256 7a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Z"/>
                            <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm.5-5v1.5h1.5v1H13V15h-1v-1.5H10.5v-1H12V12h1Z"/>
                        </svg>
                    </div>
                    <div class="info-content">
                        <span class="info-label">User ID</span>
                        <span class="info-value id-truncate" title="@userId">@TruncateId(userId)</span>
                    </div>
                </div>

            </div>

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="alert-error">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                    </svg>
                    @errorMessage
                </div>
            }
        }
    </div>
</div>

<style>
    .profile-wrapper {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 40px 16px;
    }

    .profile-card {
        background: #fff;
        border-radius: 24px;
        width: 100%;
        max-width: 520px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    /* Loading */
    .loading-state {
        padding: 60px 20px;
        text-align: center;
    }

    /* Header */
    .profile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px 24px 32px;
        text-align: center;
        position: relative;
    }

    .avatar-wrapper {
        position: relative;
        display: inline-block;
        margin-bottom: 16px;
    }

    .avatar-img {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid rgba(255,255,255,0.4);
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .avatar-placeholder {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        background: rgba(255,255,255,0.25);
        border: 4px solid rgba(255,255,255,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: 700;
        color: #fff;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .avatar-badge {
        position: absolute;
        bottom: 2px;
        right: 2px;
        background: #4ade80;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        border: 2px solid #fff;
    }

    .profile-name {
        color: #fff;
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 4px;
        letter-spacing: -0.3px;
    }

    .profile-username {
        color: rgba(255,255,255,0.75);
        font-size: 0.9rem;
        margin: 0 0 20px;
    }

    .btn-edit {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255,255,255,0.2);
        color: #fff;
        border: 2px solid rgba(255,255,255,0.4);
        border-radius: 50px;
        padding: 10px 24px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        backdrop-filter: blur(10px);
    }

    .btn-edit:hover {
        background: rgba(255,255,255,0.3);
        border-color: rgba(255,255,255,0.7);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    /* Info Grid */
    .info-grid {
        padding: 24px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .info-card {
        background: #f8f9ff;
        border: 1px solid #e8ecff;
        border-radius: 14px;
        padding: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        transition: box-shadow 0.2s ease;
    }

    .info-card:hover {
        box-shadow: 0 4px 16px rgba(102,126,234,0.15);
    }

    .info-icon {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .email-icon { background: #ede9fe; color: #7c3aed; }
    .phone-icon { background: #dcfce7; color: #16a34a; }
    .user-icon  { background: #dbeafe; color: #2563eb; }
    .id-icon    { background: #fef3c7; color: #d97706; }

    .info-content {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .info-label {
        font-size: 0.72rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 3px;
    }

    .info-value {
        font-size: 0.88rem;
        font-weight: 500;
        color: #1e293b;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .id-truncate {
        font-family: monospace;
        font-size: 0.78rem;
        color: #64748b;
    }

    /* Error */
    .alert-error {
        margin: 0 24px 24px;
        padding: 12px 16px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 10px;
        color: #dc2626;
        font-size: 0.88rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    @@media (max-width: 400px) {
        .info-grid { grid-template-columns: 1fr; }
    }
</style>

@code {
    private bool isLoading = true;
    private string? userId;
    private string? userName;
    private string? fullName;
    private string? email;
    private string? phone;
    private string? userImg;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            // Extract claims â€” JWT uses "uid" for the user ID
            userId   = user.FindFirst("uid")?.Value
                    ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            userName = user.FindFirst("sub")?.Value
                    ?? user.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value;
            email    = user.FindFirst("email")?.Value
                    ?? user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
            phone    = user.FindFirst(System.Security.Claims.ClaimTypes.MobilePhone)?.Value
                    ?? user.FindFirst("phone_number")?.Value;
            fullName = user.FindFirst("name")?.Value
                    ?? user.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value;

            // Load profile image from API
            if (!string.IsNullOrWhiteSpace(userId))
            {
                try
                {
                    var imgResponse = await Http.GetAsync($"Account/{userId}");
                    if (imgResponse.IsSuccessStatusCode)
                    {
                        var path = await imgResponse.Content.ReadAsStringAsync();
                        // Strip surrounding quotes if API returned a quoted string
                        userImg = path.Trim('"');
                    }
                }
                catch
                {
                    // Image load failure is non-fatal
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load profile: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToEdit()
    {
        Navigation.NavigateTo("/profile/edit");
    }

    private string GetInitials()
    {
        var name = string.IsNullOrWhiteSpace(fullName) ? userName : fullName;
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[^1][0]}".ToUpper()
            : name[0].ToString().ToUpper();
    }

    private string TruncateId(string? id)
    {
        if (string.IsNullOrWhiteSpace(id)) return "N/A";
        return id.Length > 12 ? $"{id[..8]}..." : id;
    }
}
