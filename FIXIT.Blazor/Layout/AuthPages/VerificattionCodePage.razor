@page "/verification/{email}"

@inject CustomAuthenticationStateProvider AuthProvider
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="container min-vh-100 d-flex align-items-center justify-content-center">
    <div class="row w-100 justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-5 text-center">

            <!-- Card -->
            <div class="card shadow-sm border-0">
                <div class="card-body py-5 px-4 px-lg-5">

                    <!-- Icon -->
                    <div class="mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             width="48" height="48" viewBox="0 0 512 512">
                            <path d="M336,208V113a80,80,0,0,0-160,0v95"
                                  fill="none" stroke="currentColor"
                                  stroke-width="32"
                                  stroke-linecap="round"
                                  stroke-linejoin="round" />
                            <rect x="96" y="208" width="320" height="272"
                                  rx="48" ry="48"
                                  fill="none" stroke="currentColor"
                                  stroke-width="32" />
                        </svg>
                    </div>

                    <!-- Text -->
                    <h3 class="fw-normal mb-3">2-Step Verification</h3>
                    <p class="text-muted mb-1">
                        We sent a verification code to your email.
                    </p>
                    <p class="text-muted mb-4">
                        Please enter the code below.
                    </p>

                    <!-- OTP Inputs -->
                    <div class="row g-2 justify-content-center mb-4">
                        <EditForm Model="@verificationCode" OnValidSubmit="@HandleVerification">
                            <DataAnnotationsValidator />

                            <div class="row g-2 justify-content-center mb-4">
                                @for (int i = 0; i < 6; i++)
                                {
                                    <div class="col-2">
                                        <InputText class="form-control form-control-lg text-center fw-bold"
                                                   maxlength="1"
                                                   inputmode="numeric"
                                                   pattern="[0-9]*"
                                                   @bind-Value="digits[i]"
                                                   @bind-Value:event="oninput" />

                                    </div>
                                }
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                Verify my account
                            </button>
                        </EditForm>
                        </div>
                </div>
            </div>

            <!-- Resend -->
            <p class="text-center text-muted mt-4">
                Didn’t receive it?
                <a href="#" class="fw-semibold text-decoration-none ms-1">
                    Resend code
                </a>
            </p>

        </div>
    </div>
</div>

@code {

    [Parameter]
    public string Email { get; set; }
    public VerificationCode verificationCode { get; set; } = new();
    private string errorMessage = string.Empty;
    private string[] digits = new string[] { "", "", "", "", "", "" };

    public async Task HandleVerification()
    {
        try
        {
            verificationCode.Code = string.Concat(digits);

            if (verificationCode.Code.Length != 6)
                return;

            var httpClient = HttpFactory.CreateClient("FIXIT.API");
            var response = await httpClient
                .PostAsync($"Auth/VerifyCode/{verificationCode.Code}?email={Email}", null);


            if(response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AuthResult>();

                await JS.InvokeVoidAsync("alert", "Verification successful!");

                if (result?.IsAuthenticated == true &&
                    !string.IsNullOrEmpty(result.Token))
                {
                    await AuthProvider.MarkUserAsAuthenticated(
                        result.Token,
                        result.RefreshToken ?? string.Empty);

                    Navigation.NavigateTo("/");
                }
            }
            else
            {
                errorMessage = "Invalid verification code. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    public class VerificationCode
    {
        public string Code { get; set; }
    }
}
